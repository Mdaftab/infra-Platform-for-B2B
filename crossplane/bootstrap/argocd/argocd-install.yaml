apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 5m
  chart:
    spec:
      chart: argo-cd
      version: "5.51.4"
      sourceRef:
        kind: HelmRepository
        name: argo-helm
        namespace: argocd
  values:
    global:
      securityContext:
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
    server:
      extraArgs:
        - --insecure
      config:
        # Allow applications in any namespace
        application.namespaces: '*'
        # Enable auto-sync
        resource.customizations.health.argoproj.io_Application: |
          hs = {}
          hs.status = "Progressing"
          hs.message = ""
          if obj.status ~= nil then
            if obj.status.health ~= nil then
              hs.status = obj.status.health.status
              if obj.status.health.message ~= nil then
                hs.message = obj.status.health.message
              end
            end
          end
          return hs
      rbacConfig:
        policy.default: role:admin
    dex:
      enabled: false
    redis:
      enabled: true
    controller:
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 250m
          memory: 256Mi
    repoServer:
      resources:
        limits:
          cpu: 300m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 256Mi
    server:
      resources:
        limits:
          cpu: 300m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 256Mi
